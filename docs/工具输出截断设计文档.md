# 工具输出截断设计文档（统一策略）

## 1. 背景
现有工具结果压缩依赖“按工具定制”的策略（如 Read/Grep/LS 等），
维护成本高、策略不一致、且容易遗漏新工具。

本设计**完全替换**旧策略，采用统一的输出截断机制（参考 Opencode）：
- **不再为每个工具设计特化压缩**
- **所有工具输出使用同一套截断规则**
- **完整输出落盘保存，随时可回溯**

## 2. 目标
1) 统一工具输出处理逻辑，避免新增工具时重复设计  
2) 控制上下文大小，提升稳定性  
3) 可追溯完整结果（落盘）  
4) 兼容现有《通用工具响应协议》  

## 3. 统一截断规则（全工具通用）
默认限制：
- `MAX_LINES = 2000`
- `MAX_BYTES = 50KB`

截断方向：
- `head`（默认保留前 2000 行）
- `tail`（可选保留后 2000 行）

处理流程：
1) 若行数 ≤ MAX_LINES 且字节数 ≤ MAX_BYTES → 原样返回  
2) 否则 → 截断 + 落盘保存 + 返回提示路径  

## 4. 落盘策略
- 目录：项目根目录下 `tool-output/`（或 `.tool-output/`）
- 文件名：`tool_<timestamp>_<toolname>.json`
- 内容：完整工具原始 JSON 输出

清理策略：
- 默认保留 7 天  
- 过期自动删除  

## 5. 截断后的返回格式
保持《通用工具响应协议》顶层字段结构：
`status / data / text / stats / context / error`

当触发截断时，建议新增字段（与当前实现一致）：

```json
{
  "status": "partial",  // 原 status 为 error 时保持 error
  "data": {
    "truncated": true,
    "truncation": {
      "direction": "head",
      "max_lines": 2000,
      "max_bytes": 51200,
      "original_lines": 5234,
      "original_bytes": 182345,
      "kept_lines": 2000,
      "kept_bytes": 49872,
      "full_output_path": "tool-output/tool_20260113_153045_Read.json"
    },
    "preview": "（截断后的内容或摘要）"
  },
  "text": "⚠️ 输出过大已截断，完整内容见 tool-output/..."
}
```

说明：
- `preview` 为截断后的**原始输出文本片段**
- `full_output_path` 提供完整输出路径
- `stats/context` 在截断时尽量沿用原始结果（便于追溯）

## 6. 跳过截断（Skip）
部分工具已有分页能力或必须保留全量结果时可跳过截断。

建议约定：
```json
{
  "context": {
    "truncation_skip": true
  }
}
```

当 `context.truncation_skip=true` 时，截断层直接放行原始输出。

## 7. 智能提示
当发生截断时，附加提示引导模型后续行动：

- 如果存在 Task 工具：  
  “Use Task to have a subagent process the full output file …”

- 否则：  
  “Use Read with pagination or Grep to search the full output file …”

## 8. 与旧策略的关系
本设计 **完全取代** 原有“按工具特化压缩”的策略：
- 不再维护 A3 表格中的 LS/Glob/Grep/Read 等特定规则
- 统一使用截断 + 落盘 + 提示
- 历史写入可直接复用截断后的输出

## 9. 配置建议（环境变量）
```
TOOL_OUTPUT_MAX_LINES=2000
TOOL_OUTPUT_MAX_BYTES=51200
TOOL_OUTPUT_TRUNCATE_DIRECTION=head
TOOL_OUTPUT_DIR=tool-output
TOOL_OUTPUT_RETENTION_DAYS=7
```

## 10. 测试建议
- 超长输出是否触发截断（行数/字节双条件）
- 截断后 JSON 仍可解析
- 落盘路径正确
- 跳过机制生效
- 过期清理生效

---

**结论**：  
该统一截断策略大幅降低维护成本，简化工具接入流程，
同时保持可追溯性与上下文可控性。
