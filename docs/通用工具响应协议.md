1. 顶层信封结构 (Standard Envelope)

所有工具返回必须严格遵守以下结构，禁止在 data / stats / context 之外添加任意自定义顶层字段。

interface ToolResponse {
  /**
   * 工具运行状态：
   * - "success": 任务完全按预期执行。
   * - "partial": 任务已执行，但结果不完整或质量有折扣
   *              （例如 Truncated, Fallback, Dry-run, 部分失败）。
   * - "error":   任务未成功执行（致命错误或无可用结果）。
   */
  status: "success" | "partial" | "error";

  /** 核心载荷：特定工具的数据封装（永远是对象，不允许 null） */
  data: Record<string, any>;

  /**
   * 给 LLM 阅读的格式化摘要：
   * 用自然语言总结本次操作结果、重要统计信息和下一步建议。
   */
  text: string;

  /**
   * 结构化错误，仅在 status === "error" 时存在。
   * code 是机器可读的错误码（例如 "NOT_FOUND", "ACCESS_DENIED"）。
   */
  error?: {
    code: string;
    message: string;
  };

  /**
   * 基础运行统计：
   * - time_ms 为必填，表示本次工具执行耗时（毫秒）。
   * - 其他可选字段用于记录条数、字节数等。
   */
  stats: {
    time_ms: number;
    [key: string]: number | string;
  };

  /**
   * 上下文信息：
   * - cwd：本次工具执行时的工作目录（相对项目根目录）。
   * - params_input：调用 run(parameters) 时传入的原始参数（原样保存）。
   * - path_resolved：如涉及路径解析，记录最终解析后的相对路径。
   */
  context: {
    cwd: string;
    params_input: any;
    path_resolved?: string;
    [key: string]: any;
  };
}

补充约定：
- 若工具需要**跳过框架级截断**（例如已实现分页读取），可在返回中设置：
  `context.truncation_skip = true`

1.1 context.cwd 的语义规范
	•	必填，不可省略。
	•	统一约定为相对项目根目录的路径字符串：
	•	大多数情况下为 "."（表示当前就在项目根目录下执行）。
	•	如果某些工具明确在子目录中执行（例如基于 working_dir），则为该子目录的相对路径（如 "src", "packages/app"）。

⸻

2. data 字段的分类约定与粒度

为防止工具之间字段命名混乱，相同类型的工具必须使用统一的字段名：

工具类别	推荐字段	说明
目录探索类 (ls)	entries	Array<Entry>，每项至少包含 { path: string; type: "file" | "dir" | "link" }
通配匹配类 (glob)	paths	string[]，匹配到的路径列表（统一为相对项目根目录的 POSIX 路径）
内容搜索 (grep)	matches	Array<{ file: string; line: number; text: string }>，一处匹配一行
文件读取 (read)	content	string，读取到的文本片段（可带行号，受 limit 约束）
修改类 (edit/write)	applied	boolean，标记是否完成真实写入/修改（非 dry-run）

截断标记统一放在 data 中：
	•	对所有可能“截断”输出的工具（ls、glob、grep、read 等）：
	•	使用 data.truncated: boolean 表示结果是否被截断。
	•	截断时，必须：
	•	设定 status = "partial"
	•	data.truncated = true
	•	在 text 中明确说明被截断的原因和下一步建议。

**框架级截断（ObservationTruncator）**：
为避免上下文膨胀，框架在**写入 history 前**可能对工具输出进行统一截断。
该截断是**二次包装**（非工具本体逻辑），其返回依然遵循本协议，但 data 结构固定为：
```
{
  "status": "partial",              // 原结果为 error 时保持 error
  "data": {
    "truncated": true,
    "truncation": {
      "direction": "head|tail",
      "max_lines": 2000,
      "max_bytes": 51200,
      "original_lines": 5234,
      "original_bytes": 182345,
      "kept_lines": 2000,
      "kept_bytes": 49872,
      "full_output_path": "tool-output/tool_YYYYMMDD_HHMMSS_Tool.json"
    },
    "preview": "...截断后的原始输出片段..."
  },
  "text": "⚠️ 输出过大已截断...",
  "stats": { ... },
  "context": { ... }
}
```
说明：
- preview 为截断后的**原始输出文本**（非工具数据结构）
- stats/context 尽量沿用原结果
- 若原 status 为 error，则保持 error（不会强制改为 partial）

⸻

3. 状态机逻辑判定 (Status Semantics)

3.1 status = "success"
满足以下条件时使用：
	•	工具任务完全按预期完成；
	•	输出结果没有截断，没有回退（fallback），没有错误；
	•	对写入类工具：操作已真实写入磁盘（data.applied === true）。

3.2 status = "partial"
结果可用，但存在“折扣”的情况，必须设为 "partial"，典型场景包括：
	1.	Truncated 输出
	•	输出被行数 / 条数限制截断，如：
	•	ls 只列出了前 100 条条目；
	•	grep 只返回了前 100 条匹配；
	•	read 只读取了前 2000 行。
	•	表达方式：
	•	status = "partial"
	•	data.truncated = true
	•	stats 里可记录相关统计（如 stats.total_entries / stats.total_matches / stats.total_lines）
	•	text 中要有明显提示：
“Results truncated to first N items. Use XXX 参数查看更多。”
	2.	Strategy Fallback
	•	如 GrepTool 中：ripgrep 不可用，降级为 Python 遍历。
	•	表达方式建议：
	•	status = "partial"（因为性能/覆盖率可能不如理想）
	•	data.fallback = "python"
	•	text 中说明：
“ripgrep not available, used slower Python search instead.”
	3.	Dry Run 编辑
	•	修改类工具在“预览模式”下，只计算 diff，但不真正写入文件。
	•	表达方式：
	•	status = "partial"
	•	data.applied = false
	•	text 中说明：
“Dry-run only, no actual write performed.”
	4.	Partial Failure（部分失败）
	•	例如批量 read/grep 多个文件，部分成功、部分失败。
	•	表达方式：
	•	status = "partial"
	•	data.failed_items = [...]（可选）
	•	text 中指出：
“3 files processed, 1 failed due to permission error.”

3.3 status = "error"
用于工具无法提供有效结果的场景，包括但不限于：
	•	Access Denied：越权访问、权限不足等。
	•	Invalid Params：正则语法错误、路径非法、参数校验失败。
	•	Fatal Timeout：在拿到任何有效数据之前就被强制中止。

在 status = "error" 时，必须设置 error 字段：

"error": {
  "code": "NOT_FOUND",
  "message": "File 'src/main.py' does not exist."
}

推荐的一些标准错误码：
	•	"NOT_FOUND"：文件/路径不存在。
	•	"ACCESS_DENIED"：路径不在 project root 内（沙箱越界）。
	•	"PERMISSION_DENIED"：操作系统权限不足（EACCES 等）。
	•	"INVALID_PARAM"：参数校验失败（例如错误的正则表达式）。
	•	"TIMEOUT"：工具在获取有效数据前超时。
	•	"INTERNAL_ERROR"：未分类的内部异常。
	•	"EXECUTION_ERROR"：其它 I/O 或执行错误（磁盘满等）。
	•	"CONFLICT"：资源在读取后被修改（乐观锁冲突）。
	•	"IS_DIRECTORY"：路径是目录而非文件。
	•	"BINARY_FILE"：文件是二进制格式，无法按文本处理。

旧版工具中顶层 "error": "Error: ..." 的字符串形式在内部应统一转换为：
	•	status = "error"
	•	error = { code: "INTERNAL_ERROR" 或更具体的错误码, message: "<原错误信息>" }
	•	顶层不再出现 error: string 这种形式。

⸻

4. 文本摘要 (text) 的最低要求

text 是 LLM 直接看的那一段，人类味要重一点，至少要包含三部分信息：
	1.	动作结论（做了什么 + 结果如何）
	•	例：Found 5 matches for 'class ' in 2 files.
	•	例：Listed 20 entries in 'src'.
	2.	状态说明（尤其是 partial 时）
	•	例：(Results truncated to first 100 matches.)
	•	例：(Using Python fallback search because ripgrep is not available.)
	3.	下一步指引（当是 partial 或 error 时）
	•	partial：
	•	Try increasing 'limit' or narrowing the 'path'.
	•	Use 'start_line' to read the next page of the file.
	•	error：
	•	Check if the path is correct or run LS[...] to inspect the directory.

示例（partial + truncated）：

"text": "Found 100 matches for 'TODO' in 'src/' (truncated to first 100). \
Try narrowing the path or pattern, or increase 'limit' if supported by this tool."


⸻

5. 示例：ListFilesTool (ls) 的标准化返回

{
  "status": "partial",
  "data": {
    "entries": [
      { "path": "src/main.py", "type": "file" },
      { "path": "src/utils/", "type": "dir" }
    ],
    "truncated": true
  },
  "text": "Listed 2 entries in 'src' (truncated from 500 total). \
Consider using 'search_code' for deeper lookup or increasing 'limit'.",
  "error": null,
  "stats": {
    "time_ms": 150,
    "total_entries": 500
  },
  "context": {
    "cwd": ".",
    "params_input": { "path": "src", "limit": 2 },
    "path_resolved": "src"
  }
}
