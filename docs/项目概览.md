# 项目概览

## 项目目标

MyCodeAgent 是一个面向学习与实验的 ReAct（Reasoning + Acting）代码代理项目，主要用于实践：
- ReAct 工作流与工具调用
- 上下文工程（截断、压缩、归档）
- Skills / Task 子代理能力
- 搭建可扩展的本地实验框架

> 参见：[`README.md`](../README.md)

## 核心模块

### 基础设施 (`core/`)
- **Agent 基类** (`core/agent.py`): 定义 Agent 抽象基类，提供消息历史管理
- **LLM 封装** (`core/llm.py`): 统一 LLM 调用接口，支持多供应商
- **消息模型** (`core/message.py`): 定义 Message 数据结构
- **配置管理** (`core/config.py`): 从环境变量加载配置
- **上下文引擎** (`core/context_engine/`):
  - `context_builder.py`: 构建上下文提示词
  - `history_manager.py`: 会话历史管理与压缩
  - `input_preprocessor.py`: 预处理用户输入（@file 强制 Read）
  - `summary_compressor.py`: 历史压缩生成器
  - `observation_truncator.py`: 工具输出截断管理
  - `trace_logger.py`: 可选的 JSONL 追踪日志

### Agent 实现 (`agents/`)
- **CodeAgent** (`agents/codeAgent.py`): 基于 ReAct 的代码助手
  - 实现 Thought → Action → Observation 循环
  - 集成工具注册表和上下文管理
  - 支持交互式 CLI 和调试模式

### 工具系统 (`tools/`)
- **工具基类** (`tools/base.py`): 定义 Tool 抽象基类和 ToolParameter 模型
- **工具注册表** (`tools/registry.py`): 统一管理和执行工具
- **内置工具** (`tools/builtin/`):
  - `list_files.py`: 目录浏览（LS）
  - `search_files_by_name.py`: 文件名搜索（Glob）
  - `search_code.py`: 代码内容搜索（Grep）
  - `read_file.py`: 文件读取（Read）
  - `write_file.py`: 文件写入（Write）
  - `edit_file.py`: 单点编辑（Edit）
  - `edit_file_multi.py`: 多点编辑（MultiEdit）
  - `todo_write.py`: 任务清单管理（TodoWrite）
  - `bash.py`: 命令执行（Bash）
  - `skill.py`: 技能加载（Skill）
  - `task.py`: 子代理委派（Task）
  - `ask_user.py`: 向用户提问（AskUser）
- **MCP 集成** (`tools/mcp/`):
  - `loader.py`: 加载 MCP 服务器配置
  - `config.py`: 从环境变量或文件读取配置
  - `adapter.py`: MCP 客户端适配器
  - `protocol.py`: MCP 响应协议转换

### 提示词系统 (`prompts/`)
- **工具提示词** (`prompts/tools_prompts/`): 每个工具对应的 Python 提示词常量
- **Agent 提示词** (`prompts/agents_prompts/`): CodeAgent 等的系统提示词

### 技能系统 (`skills/`)
- 技能定义存储在 `skills/<name>/SKILL.md`
- 支持参数扩展（`$ARGUMENTS` 占位符）
- 运行时按需加载

### 入口脚本 (`scripts/`)
- **交互式 CLI** (`scripts/chat_test_agent.py`): 主入口，支持多供应商模型和调试选项

### 文档 (`docs/`)
- 设计文档和交接说明
- 工具协议和上下文工程规范

### 测试与评估 (`tests/`, `eval/`)
- **单元测试** (`tests/`): 使用 pytest 的工具和组件测试
- **评估框架** (`eval/`):
  - `run_eval.py`: 评估运行器
  - `tasks/`: 测试任务定义
  - `fixtures/`: 测试用例文件
  - `reports/`: 评估结果报告

## 主要功能

### 1. ReAct 推理循环
CodeAgent 实现标准的 ReAct 工作流：
1. **Thought**: 思考当前状态和下一步行动
2. **Action**: 选择并调用工具
3. **Observation**: 观察工具结果并更新上下文
4. 循环直到完成任务

> 实现位置：[`agents/codeAgent.py`](../agents/codeAgent.py)

### 2. 统一工具响应协议
所有工具必须遵循 [`docs/通用工具响应协议.md`](通用工具响应协议.md)：
- 顶层字段：`status`, `data`, `text`, `stats`, `context`（以及 `error`，仅在失败时）
- 状态值：`success`, `partial`, `error`

### 3. 内置工具集
12 个内置工具覆盖代码操作全流程：
- 文件系统：LS, Glob, Read, Write, Edit, MultiEdit
- 代码搜索：Grep（优先使用 ripgrep）
- 任务管理：TodoWrite
- 系统操作：Bash
- 扩展机制：Skill, Task, AskUser

### 4. 上下文工程
- **历史压缩**: 自动触发 LLM 生成对话摘要
- **工具输出截断**: 超限结果落盘到 `tool-output/`
- **@file 强制 Read**: 识别文件引用并自动读取
- **mtime 变化提醒**: 检测文件修改避免冲突

### 5. Skills 系统（MVP）
- 从 `skills/**/SKILL.md` 按需加载技能
- 支持参数扩展和运行时刷新
- 适用于标准化工作流程

### 6. Task 子代理（MVP）
四种子代理类型：
- **general**: 通用复杂任务
- **explore**: 代码库扫描和发现
- **plan**: 实现步骤规划
- **summary**: 长输出压缩

支持 `main`/`light` 模型选择，子代理工具权限隔离。

### 7. MCP 工具集成
- 从 `mcp_servers.json` 加载远程服务器配置
- 支持 HTTP/stdio 传输协议
- 自动将 MCP 工具转换为统一协议格式

### 8. Enhanced UI
- 工具调用树可视化
- Token 使用统计
- 进度显示
- 原始响应调试模式（`--show-raw`）

## 快速开始

```bash
# 安装依赖
pip install -r requirements.txt

# 运行交互式 CLI
python scripts/chat_test_agent.py

# 使用自定义模型
python scripts/chat_test_agent.py \
  --provider zhipu \
  --model GLM-4.7 \
  --api-key YOUR_API_KEY

# 调试模式
python scripts/chat_test_agent.py --show-raw

# 运行测试
python -m pytest tests/ -v

# 运行评估
python eval/run_eval.py --suite base
```

## 技术栈

- **语言**: Python 3
- **LLM**: 支持多供应商（OpenAI, Zhipu 等）
- **工具**: ripgrep（优先）, os.walk, pathlib
- **测试**: pytest
- **UI**: rich, prompt_toolkit
- **协议**: MCP (Model Context Protocol)

## 架构特点

1. **沙箱隔离**: 所有工具强制注入 `project_root`，防止路径逃逸
2. **熔断保护**: Glob/Grep 等工具有访问数和时间双重限制
3. **确定性结果**: 文件遍历按字母排序，保证输出稳定
4. **协议优先**: 所有工具遵循统一响应协议，便于扩展
5. **可插拔设计**: 工具注册表支持 Tool 对象和函数两种注册方式

## 相关文档

- [通用工具响应协议](通用工具响应协议.md)
- [上下文工程设计文档](上下文工程设计文档.md)
- [工具输出截断设计文档](工具输出截断设计文档.md)
- [项目交接说明](DEV_HANDOFF.md)
- [代码规范指南](../CODE_LAW.md)
- [用户文档](../README.md)
