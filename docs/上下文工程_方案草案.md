# 上下文工程方案（草案）

本方案用于指导 ContextBuilder 的实现与上下文拼接策略，保持 ReActEngine 只负责循环/解析/执行/短期历史。

## 目标
- 保留必要上下文，避免重复读文件与无效膨胀。
- 工具输出分级压缩，Read/Edit 等保留关键片段。
- 历史摘要结构化，避免“重复压缩”与语义漂移。

---

## 1) 工具压缩规则表（草案）

> 原则：**导航类摘要、内容类保留片段、变更类保留摘要**。
> 关键规则：**工具返回给模型的 Observation 保持完整；写入历史的版本必须压缩**。

| 工具 | 默认上下文注入 | 备注 |
|---|---|---|
| **LS** | 仅摘要：目录 + 统计 + 前 N 项 | 不保留全量列表 |
| **Glob** | 仅摘要：pattern + 命中数 + 前 N 项 | 命中多时保留前 5-10 |
| **Grep** | 摘要 + 前 N 条匹配行 | N = 5（带文件名与行号） |
| **Read** | **保留片段内容**（带行号） | 上限 500 行，仅保留当前读取区间 |
| **Edit / MultiEdit** | 变更摘要（文件 + 变更区间 + 关键片段） | 大 diff 仅保留摘要 |
| **Write** | 变更摘要（文件 + 新增/覆盖 + 片段） | 新文件仅保留前 20-50 行 |
| **Bash** | 摘要 + stderr 尾部 | stderr 末尾 20 行，stdout 仅摘要 |
| **TodoWrite** | 仅保留 recap | 不保留完整列表（完整列表由工具返回） |

建议默认最大注入行数：
- Read：最多 500 行
- Grep：最多 5 行
- Edit/Write 片段：20-50 行

安全与压缩规则：
- History 中**不保留完整工具 JSON**，只保留压缩摘要。
- 对敏感字段进行过滤（如密钥、token、password、api key 等），疑似敏感内容以 `<REDACTED>` 替换。

---

## 2) History Summary 结构模板（草案）

> 历史摘要不放在 system prompt 内，放在 Message History 的 `system` 消息中。  
> 原则：**结构化 > 自由文本**（用固定表单填空，避免漂移与遗漏）。

**模板（结构化）**：
```
[History Summary]
- Overall Goal: <用户最初目标 + 当前最终目标（1行）>
- Current Plan & Progress: <当前进度 + 下一步（1行）>
- Environment / Files: <已创建/修改/读取的关键文件或路径，逗号分隔>
- Key Knowledge / Insights: <关键事实/结论/URL（短句，多条用 ; 分隔）>
- Recent Actions: <最近工具调用的简述与直接结果（1-2行）>
- Left-off Point: <压缩前停在的具体环节/阻塞点（1行）>
```

**规则**：
- 仅压缩“旧对话”，不要重复压缩已有 summary。
- **保留最近 3-5 轮原始消息**（含工具调用与结果，Full Detail）。
- Summary 生成后替换旧对话块，保持可续接性。
- 大型内容仅保留**引用**（文件路径/URL），不在 summary 内展开。

**多级摘要（可选，后续）**：
- 当 summary 本身过长时，对 summary 再次提炼为更高层级摘要。
- 高层摘要只保留战略性信息（目标/关键文件/未完成事项）。

---

## 3) ContextBuilder 拼接顺序与预算策略（草案）

### 拼接顺序（固定）
1. **System prompt**（静态规则）
2. **code_law.md**（缓存内容，若 mtime 未变则复用）
3. **Tools prompts**（静态规则）
4. **History Summary**（system role，结构化摘要）
5. **Recent Messages**（最近 2-4 轮，含 tool 消息）
6. **User Input**（当前问题）
7. **Todo recap**（短、明确、可复述）

### 预算策略（建议）
- 设定总 token 预算：**16k**。
- Recent Messages 固定保留 **5 轮**。
- **code_law.md 不允许裁剪**（只缓存复用）。
- 当上下文占用达到 **50%** 时，自动启用 History Summary。
- 优先保留层级：System/code_law/Tools > User Input > Recent Messages > Summary > Tool snippets > Todo recap
- 当预算超限时：
  1) 先裁剪工具片段长度
  2) 再裁剪 Summary 字段长度（每行缩短为 1 句）

---

## 4) 实施步骤（结合当前代码结构）

> 目标：在**不改动 ReAct 协议**的前提下，为 CodeAgent 提供可控、可扩展的上下文管理能力。

### 阶段 A：拆分 PromptBuilder（已完成/验收）
1. **ReActEngine 只接收 ContextBuilder 产物**  
   - `agentEngines/ReActEngine.py` 不再拼 prompt，只消费 `context_builder.build(...)`。
2. **CodeAgent/TestAgent 持有 ContextBuilder**  
   - `agents/codeAgent.py`、`agents/testAgent.py` 实例化 `ContextBuilder` 并传入 Engine。

### 阶段 B：上下文源加载与缓存
1. **System Prompt / Tool Prompts 统一入口**  
   - `core/context_builder.py` 统一加载：
     - Agent system prompt（静态）
     - `prompts/tools_prompts/*.md`（静态）
2. **code_law.md 的缓存**  
   - 读取文件内容并缓存 `mtime`，仅当 `mtime` 变化时重新载入。
   - 当首次进入会话且 `code_law.md` 不存在时，仅记录“需生成”的标记（由 Agent 询问用户是否生成）。

### 阶段 C：工具输出压缩与历史存储
1. **新增 ToolResponseCompressor（建议新模块）**  
   - 文件建议：`core/tool_compress.py`  
   - 统一实现：`compress(tool_name, tool_result) -> summary_text`
   - 与“工具压缩规则表”一一对应。
2. **History 双轨制（原始 + 压缩）**  
   - 原始 Observation 仅用于**当前 ReAct 回合**。
   - 写入 history 时使用压缩版（summary_text），避免膨胀。

### 阶段 D：History Summary 生成与替换
1. **新增 HistorySummarizer（建议新模块）**  
   - 文件建议：`core/history_summarizer.py`  
   - 输入：旧消息片段  
   - 输出：结构化 Summary（固定模板）
2. **Summary 触发条件**  
   - 在 ContextBuilder 内进行预算估算  
   - 当上下文占用达到 **50%**，触发 summary 生成并替换旧对话块
3. **保留最近 3-5 轮原始消息**  
   - Summary 只压缩旧消息  
   - 最近轮次保持 Full Detail

### 阶段 E：预算估算与裁剪策略
1. **引入 Token/字符预算估算**  
   - MVP：使用粗略字符换算（如 1 token ≈ 4 chars）  
   - 文件建议：`core/token_budget.py`
2. **超限时的裁剪顺序**  
   - 先裁剪工具片段  
   - 再裁剪 Summary 行  
   - 最后减少 Recent Messages 轮数（但至少保留 2 轮）

### 阶段 F：Todo 逻辑与 Recap 绑定
1. **TodoWrite 工具仍输出结构化 JSON**  
   - 对模型的下一轮上下文只注入 “recap”  
2. **Recap 只在 Todo 存在时注入**  
   - ContextBuilder 在构建时检测 `todo_state` 是否存在

### 阶段 G：验收与迭代
1. **测试策略**  
   - 模拟长对话，检查 summary 是否触发  
   - 验证裁剪顺序符合预期  
   - 确认工具摘要未泄露敏感字段
2. **性能优化（后续）**  
   - 引入更准确的 token 统计  
   - 多级摘要策略  
   - 可配置裁剪策略（按 Agent 或任务类型）

---

## 补充约束
- system prompt 仅存静态规则，不混入动态摘要。
- Thought 不长期保留；History 中保留 Action/Observation 及工具摘要。
- code_law.md 仅在用户要求时更新；自动读取仅发生在首次会话或 mtime 变化时。

---

## code_law.md 生成规则（首次使用 CodeAgent）

- 触发时机：**首次使用 CodeAgent** 时检查 `code_law.md` 是否存在。
- 若不存在：**先询问用户是否生成**（方案 B）。
- 用户确认后，系统提供给Agent一个固定的初始化检索提示词： "Generate a file named code_law.md that serves as a contributor guide for this
  repository.
  Your goal is to produce a clear, concise, and well-structured document with
  descriptive headings and actionable explanations for each section.
  Follow the outline below, but adapt as needed — add sections if relevant, and omit
  those that do not apply to this project.

  Document Requirements

  - Title the document "Repository Guidelines".
  - Use Markdown headings (#, ##, etc.) for structure.
  - Keep the document concise. 200-400 words is optimal.
  - Keep explanations short, direct, and specific to this repository.
  - Provide examples where helpful (commands, directory paths, naming patterns).
  - Maintain a professional, instructional tone.

  Recommended Sections

  Project Structure & Module Organization

  - Outline the project structure, including where the source code, tests, and assets
  are located.

  Build, Test, and Development Commands

  - List key commands for building, testing, and running locally (e.g., npm test,
  make build).
  - Briefly explain what each command does.

  Coding Style & Naming Conventions

  - Specify indentation rules, language-specific style preferences, and naming
  patterns.
  - Include any formatting or linting tools used.

  Testing Guidelines

  - Identify testing frameworks and coverage requirements.
  - State test naming conventions and how to run tests.

  Commit & Pull Request Guidelines

  - Summarize commit message conventions found in the project’s Git history.
  - Outline pull request requirements (descriptions, linked issues, screenshots,
  etc.).

  (Optional) Add other sections if relevant, such as Security & Configuration Tips,
  Architecture Overview, or Agent-Specific Instructions."
  - Agent 通过 LS/Glob/Grep/Read 收集项目结构、命令与规范信息。
  - 基于项目实际内容生成 `code_law.md`（不使用固定模板）。
- 后续仅在用户明确要求时更新 `code_law.md`。

---
