# MyCodeAgent 项目概览

## 项目目标

MyCodeAgent 是一个面向学习与实验的**代码代理框架**，聚焦于以下核心领域的系统化实践：

- **工具协议**：统一的工具调用与响应规范
- **上下文工程**：历史管理、压缩、持久化
- **子代理机制**：任务委托与协作
- **可观测性**：完整追踪与调试能力

> 核心使命：让"Agent 能做什么"与"Agent 为什么能做"都可追溯、可验证、可扩展。

## 适用场景

根据 `README.md`，项目适用于：
- 学习 function calling + 工具协议的真实落地
- 研究上下文工程（截断、压缩、持久化）
- 实验 Skills / Task 子代理协作
- 快速搭建可扩展的本地 Agent 试验场

## 核心模块架构

### 1. 核心运行时 (`core/`)

- **`agent.py`** - Agent 基类，定义了统一的代理接口
- **`llm.py`** - LLM 封装，支持多供应商
- **`message.py`** - 消息模型，基于 Pydantic
- **`config.py`** - 配置管理
- **`context_engine/`** - 上下文工程核心
  - `history_manager.py` - 历史记录管理
  - `context_builder.py` - 上下文构建器
  - `observation_truncator.py` - 工具输出截断
  - `summary_compressor.py` - 历史压缩
  - `trace_logger.py` - 追踪日志
  - `trace_sanitizer.py` - 敏感信息脱敏
- **`skills/`** - 技能加载机制

### 2. 代理实现 (`agents/`)

- **`codeAgent.py`** - 基于 ReAct 的代码助手，实现了完整的代理循环

### 3. 工具系统 (`tools/`)

- **`base.py`** - 工具基类与协议
- **`registry.py`** - 工具注册表
- **`circuit_breaker.py`** - 熔断机制
- **`builtin/`** - 内置工具集
  - `list_files.py` - 目录列表
  - `search_files_by_name.py` - 文件名搜索
  - `search_code.py` - 代码内容搜索
  - `read_file.py` - 文件读取
  - `write_file.py` - 文件写入
  - `edit_file.py` - 单文件编辑
  - `edit_file_multi.py` - 多文件原子编辑
  - `bash.py` - Shell 命令执行
  - `todo_write.py` - 任务列表管理
  - `skill.py` - 技能加载
  - `task.py` - 子代理调用
  - `ask_user.py` - 用户交互
- **`mcp/`** - MCP 服务器集成
  - `client.py` - MCP 客户端
  - `loader.py` - 服务器加载器
  - `protocol.py` - 协议适配

### 4. 提示词系统 (`prompts/`)

- 系统提示词
- 工具提示词（Python 字符串常量）

### 5. 技能定义 (`skills/`)

遵循目录约定：`skills/<skill-name>/SKILL.md`

### 6. 测试与评估

- **`tests/`** - pytest 测试套件
- **`eval/`** - 评估任务与运行器

### 7. 文档 (`docs/`)

详细的设计文档，包括：
- `通用工具响应协议.md` - 工具协议规范
- `上下文工程设计文档.md` - 上下文工程方案
- `工具输出截断设计文档.md` - 截断策略
- `TraceLogging设计文档.md` - 追踪系统
- `task(subagent)设计文档.md` - 子代理机制
- `skillTool设计文档.md` - 技能系统

## 主要功能特性

### 1. 统一工具响应协议

所有工具必须遵循严格的响应结构（`docs/通用工具响应协议.md`）：

```typescript
interface ToolResponse {
  status: "success" | "partial" | "error";
  data: Record<string, any>;
  text: string;  // 给 LLM 阅读的摘要
  error?: { code: string; message: string };
  stats: { time_ms: number; [key: string]: number | string };
  context: { cwd: string; params_input: any; path_resolved?: string };
}
```

### 2. 分层上下文工程

根据 `docs/上下文工程设计文档.md`：

- **L1 系统静态层**：System Prompt + 工具提示词
- **L2 项目规则层**：`CODE_LAW.md`（可选）
- **L3 会话历史层**：消息历史 + system summary

注入顺序：L1 → L2 → L3 → 当前用户输入 → Todo recap

### 3. 工具输出截断与落盘

- `MAX_LINES = 2000`
- `MAX_BYTES = 50KB`
- 超限输出写入 `tool-output/` 目录
- 支持跳过机制（`context.truncation_skip = true`）

### 4. 子代理机制（Task Tool）

根据 `docs/task(subagent)设计文档.md`：

- 支持四种子代理类型：`general / explore / plan / summary`
- 双模型路由：`main`（主模型）和 `light`（轻量模型）
- 工具权限隔离（防止递归调用）
- 独立会话历史

### 5. 技能系统（Skill Tool）

根据 `docs/skillTool设计文档.md`：

- 技能存储：`skills/<skill-name>/SKILL.md`
- Markdown + YAML frontmatter 格式
- 必需字段：`name`, `description`
- 支持 `$ARGUMENTS` 占位符替换

### 6. 可观测性

- **Trace 追踪**：JSONL + Markdown 双轨日志
- **敏感信息脱敏**：自动过滤 API keys、密码等
- **会话持久化**：支持 `/save` 和 `/load`
- **Enhanced CLI UI**：工具调用树、token 统计、进度显示

### 7. MCP 扩展

通过 `mcp_servers.json` 配置外部 MCP 服务器，支持：
- Google Drive
- Figma
- Slack
- 自定义开发工具

### 8. 熔断机制

连续失败的工具自动临时禁用，防止无限重试。

## 技术栈

- **语言**：Python 3.x
- **核心库**：openai / pydantic / mcp / anyio
- **UI 库**：rich / prompt_toolkit
- **测试框架**：pytest

## 与同类产品对比

### vs Claude Code CLI

| 特性 | MyCodeAgent | Claude Code CLI |
|------|-------------|----------------|
| **工具协议** | 统一响应协议（status/data/text/stats/context/error） | 专有协议 |
| **上下文工程** | 分层注入 + 历史压缩 + 截断落盘 | 自动管理 |
| **子代理** | 内置 Task 工具（4种类型 + 双模型） | Subagents 功能 |
| **技能系统** | 本地 SKILL.md 文件 | CLAUDE.md + slash commands |
| **可观测性** | JSONL + Markdown 双轨追踪 + 脱敏 | 内置日志 |
| **MCP 集成** | 原生支持 | 原生支持 |
| **学习目标** | 面向学习与实验 | 面向生产使用 |
| **开源** | 完全开源 | 闭源 |

**核心差异**：
- MyCodeAgent 专注于**协议标准化**和**可观测性**，适合学习和研究
- Claude Code CLI 专注于**用户体验**和**生产效率**
- MyCodeAgent 的统一工具协议和分层上下文工程提供了更细粒度的控制

### vs GitHub Copilot CLI

| 特性 | MyCodeAgent | GitHub Copilot CLI |
|------|-------------|-------------------|
| **工具调用** | Function Calling（结构化） | 自然语言指令 |
| **可扩展性** | 自定义工具 + MCP | 有限 |
| **子代理** | 完整实现 | 无 |
| **技能系统** | 本地文件管理 | 无 |
| **追踪** | 完整追踪系统 | 基础日志 |

**核心差异**：
- MyCodeAgent 基于**结构化工具调用**，Copilot CLI 基于**自然语言**
- MyCodeAgent 提供完整的**子代理和技能系统**，Copilot CLI 专注于快速迭代

## 快速开始

```bash
# 安装依赖
pip install -r requirements.txt

# 运行交互式 CLI
python scripts/chat_test_agent.py

# 指定模型与供应商
python scripts/chat_test_agent.py \
  --provider zhipu \
  --model GLM-4.7 \
  --api-key YOUR_API_KEY \
  --base-url https://open.bigmodel.cn/api/coding/paas/v4

# 开启原始输出（调试）
python scripts/chat_test_agent.py --show-raw

# 运行测试
python -m pytest tests/ -v

# 运行评估
python eval/run_eval.py --suite all
```

## 核心设计理念

1. **协议优先**：所有工具遵循统一响应协议，确保一致性和可预测性
2. **可观测性优先**：完整的追踪、日志和脱敏机制
3. **可扩展性优先**：通过 MCP 和自定义工具轻松扩展
4. **学习友好**：详细的设计文档和清晰的代码结构
5. **渐进式复杂度**：MVP 范围明确，非目标清晰标注

## 参考资源

项目在 `README.md` 中致谢了以下开源项目：
- [Datawhale HelloAgents](https://github.com/jjyaoao/HelloAgents.git)
- [shareAI-lab Kode-Cli](https://github.com/shareAI-lab/Kode-cli.git)
- [MiniMax-AI Mini-Agent](https://github.com/MiniMax-AI/Mini-Agent)
- [anomalyco opencode](https://github.com/anomalyco/opencode)

## 许可证

MIT License
