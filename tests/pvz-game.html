<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¤ç‰©å¤§æˆ˜åƒµå°¸ - å¡é€šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Nunito', sans-serif;
        }
        .title-font {
            font-family: 'Fredoka One', cursive;
        }
        .cartoon-shadow {
            box-shadow: 4px 4px 0px #000;
        }
        .cartoon-border {
            border: 3px solid #000;
        }
        .plant-card:hover {
            transform: scale(1.05);
            box-shadow: 6px 6px 0px #000;
        }
        .sun {
            animation: sunPulse 2s ease-in-out infinite;
        }
        @keyframes sunPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .zombie-walk {
            animation: zombieWalk 0.5s ease-in-out infinite;
        }
        @keyframes zombieWalk {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .pea-shoot {
            animation: peaShoot 0.3s ease-out;
        }
        @keyframes peaShoot {
            0% { transform: scale(0.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }
        .bounce-in {
            animation: bounceIn 0.5s ease-out;
        }
        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gradient-to-b from-sky-300 to-green-300 min-h-screen overflow-hidden">
    <!-- æ¸¸æˆæ ‡é¢˜ -->
    <div class="text-center py-4">
        <h1 class="title-font text-5xl text-white cartoon-shadow tracking-wider">
            ğŸŒ» æ¤ç‰©å¤§æˆ˜åƒµå°¸ ğŸ§Ÿ
        </h1>
    </div>

    <!-- æ¸¸æˆå®¹å™¨ -->
    <div class="flex justify-center gap-4 px-4">
        <!-- æ¤ç‰©é€‰æ‹©æ  -->
        <div class="bg-amber-100 cartoon-border cartoon-shadow rounded-2xl p-4 w-32">
            <h2 class="title-font text-xl text-center mb-3 text-amber-800">æ¤ç‰©</h2>
            <div class="space-y-3">
                <!-- å‘æ—¥è‘µ -->
                <div class="plant-card bg-yellow-300 cartoon-border cartoon-shadow rounded-xl p-2 cursor-pointer transition-all duration-200 flex flex-col items-center" onclick="selectPlant('sunflower')">
                    <div class="text-4xl">ğŸŒ»</div>
                    <div class="text-xs font-bold text-yellow-800 mt-1">å‘æ—¥è‘µ</div>
                    <div class="text-xs text-yellow-600">50â˜€ï¸</div>
                </div>
                <!-- è±Œè±†å°„æ‰‹ -->
                <div class="plant-card bg-green-400 cartoon-border cartoon-shadow rounded-xl p-2 cursor-pointer transition-all duration-200 flex flex-col items-center" onclick="selectPlant('peashooter')">
                    <div class="text-4xl">ğŸŒ±</div>
                    <div class="text-xs font-bold text-green-800 mt-1">è±Œè±†å°„æ‰‹</div>
                    <div class="text-xs text-green-600">100â˜€ï¸</div>
                </div>
                <!-- åšæœå¢™ -->
                <div class="plant-card bg-orange-300 cartoon-border cartoon-shadow rounded-xl p-2 cursor-pointer transition-all duration-200 flex flex-col items-center" onclick="selectPlant('wallnut')">
                    <div class="text-4xl">ğŸ¥”</div>
                    <div class="text-xs font-bold text-orange-800 mt-1">åšæœå¢™</div>
                    <div class="text-xs text-orange-600">50â˜€ï¸</div>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆç”»å¸ƒ -->
        <div class="relative">
            <!-- é˜³å…‰è®¡æ•°å™¨ -->
            <div class="absolute top-0 left-0 bg-yellow-400 cartoon-border cartoon-shadow rounded-xl px-4 py-2 z-10 flex items-center gap-2">
                <span class="text-2xl">â˜€ï¸</span>
                <span id="sunCount" class="title-font text-2xl text-yellow-900">100</span>
            </div>

            <!-- æ¸¸æˆåŒºåŸŸ -->
            <canvas id="gameCanvas" class="bg-green-600 cartoon-border cartoon-shadow rounded-2xl" width="900" height="500"></canvas>

            <!-- æ¸¸æˆç»“æŸè¦†ç›–å±‚ -->
            <div id="gameOver" class="hidden absolute inset-0 bg-black/70 rounded-2xl flex flex-col items-center justify-center">
                <h2 class="title-font text-5xl text-red-500 cartoon-shadow mb-4">æ¸¸æˆç»“æŸ!</h2>
                <button onclick="restartGame()" class="bg-green-500 hover:bg-green-600 cartoon-border cartoon-shadow rounded-xl px-8 py-3 title-font text-xl text-white transition-all duration-200 hover:scale-105">
                    é‡æ–°å¼€å§‹
                </button>
            </div>
        </div>

        <!-- ä¿¡æ¯é¢æ¿ -->
        <div class="bg-purple-100 cartoon-border cartoon-shadow rounded-2xl p-4 w-32">
            <h2 class="title-font text-xl text-center mb-3 text-purple-800">ä¿¡æ¯</h2>
            <div class="space-y-3 text-sm">
                <div class="bg-white cartoon-border rounded-lg p-2">
                    <div class="font-bold text-purple-700">åˆ†æ•°</div>
                    <div id="score" class="title-font text-2xl text-purple-900">0</div>
                </div>
                <div class="bg-white cartoon-border rounded-lg p-2">
                    <div class="font-bold text-red-700">åƒµå°¸</div>
                    <div id="zombieCount" class="title-font text-2xl text-red-900">0</div>
                </div>
                <div class="bg-white cartoon-border rounded-lg p-2">
                    <div class="font-bold text-blue-700">æ³¢æ¬¡</div>
                    <div id="wave" class="title-font text-2xl text-blue-900">1</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œæç¤º -->
    <div class="text-center mt-4 text-white font-bold text-lg cartoon-shadow">
        ç‚¹å‡»é€‰æ‹©æ¤ç‰©ï¼Œå†ç‚¹å‡»è‰åªç§æ¤ | æ”¶é›†é˜³å…‰æ¥è´­ä¹°æ›´å¤šæ¤ç‰©
    </div>

    <script>
        // æ¸¸æˆé…ç½®
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const GRID_ROWS = 5;
        const GRID_COLS = 9;
        const CELL_WIDTH = 100;
        const CELL_HEIGHT = 100;
        
        // æ¸¸æˆçŠ¶æ€
        let sun = 100;
        let score = 0;
        let wave = 1;
        let selectedPlant = null;
        let plants = [];
        let zombies = [];
        let projectiles = [];
        let suns = [];
        let gameRunning = true;
        
        // æ¤ç‰©ç±»å‹
        const PLANT_TYPES = {
            sunflower: { cost: 50, hp: 300, emoji: 'ğŸŒ»', color: '#FBBF24', name: 'å‘æ—¥è‘µ' },
            peashooter: { cost: 100, hp: 300, emoji: 'ğŸŒ±', color: '#4ADE80', name: 'è±Œè±†å°„æ‰‹' },
            wallnut: { cost: 50, hp: 2000, emoji: 'ğŸ¥”', color: '#F97316', name: 'åšæœå¢™' }
        };
        
        // æ¤ç‰©ç±»
        class Plant {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.hp = PLANT_TYPES[type].hp;
                this.maxHp = PLANT_TYPES[type].hp;
                this.emoji = PLANT_TYPES[type].emoji;
                this.color = PLANT_TYPES[type].color;
                this.shootTimer = 0;
                this.sunTimer = 0;
            }
            
            draw() {
                // ç»˜åˆ¶æ¤ç‰©èƒŒæ™¯
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x + CELL_WIDTH/2, this.y + CELL_HEIGHT/2, 35, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // ç»˜åˆ¶emoji
                ctx.font = '40px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.emoji, this.x + CELL_WIDTH/2, this.y + CELL_HEIGHT/2);
                
                // ç»˜åˆ¶è¡€æ¡
                const hpPercent = this.hp / this.maxHp;
                ctx.fillStyle = '#000';
                ctx.fillRect(this.x + 20, this.y + 10, 60, 8);
                ctx.fillStyle = hpPercent > 0.5 ? '#22C55E' : hpPercent > 0.25 ? '#EAB308' : '#EF4444';
                ctx.fillRect(this.x + 22, this.y + 12, 56 * hpPercent, 4);
            }
            
            update() {
                if (this.type === 'peashooter') {
                    this.shootTimer++;
                    if (this.shootTimer >= 90) { // æ¯1.5ç§’å°„å‡»ä¸€æ¬¡
                        this.shoot();
                        this.shootTimer = 0;
                    }
                } else if (this.type === 'sunflower') {
                    this.sunTimer++;
                    if (this.sunTimer >= 600) { // æ¯10ç§’äº§ç”Ÿé˜³å…‰
                        this.produceSun();
                        this.sunTimer = 0;
                    }
                }
            }
            
            shoot() {
                // æ£€æµ‹è¯¥è¡Œæ˜¯å¦æœ‰åƒµå°¸
                const row = Math.floor(this.y / CELL_HEIGHT);
                const hasZombie = zombies.some(z => 
                    Math.floor(z.y / CELL_HEIGHT) === row && z.x > this.x
                );
                
                if (hasZombie) {
                    projectiles.push(new Projectile(
                        this.x + CELL_WIDTH/2,
                        this.y + CELL_HEIGHT/2 - 10
                    ));
                }
            }
            
            produceSun() {
                suns.push(new Sun(this.x + CELL_WIDTH/2, this.y + CELL_HEIGHT/2));
            }
        }
        
        // åƒµå°¸ç±»
        class Zombie {
            constructor(y) {
                this.x = canvas.width;
                this.y = y;
                this.hp = 100 + wave * 20;
                this.maxHp = this.hp;
                this.speed = 0.3 + wave * 0.05;
                this.damage = 0.5;
                this.emoji = 'ğŸ§Ÿ';
                this.eating = false;
                this.eatTimer = 0;
            }
            
            draw() {
                // ç»˜åˆ¶åƒµå°¸èƒŒæ™¯
                ctx.fillStyle = '#6B7280';
                ctx.beginPath();
                ctx.arc(this.x + CELL_WIDTH/2, this.y + CELL_HEIGHT/2, 35, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // ç»˜åˆ¶emoji
                ctx.font = '40px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.emoji, this.x + CELL_WIDTH/2, this.y + CELL_HEIGHT/2);
                
                // ç»˜åˆ¶è¡€æ¡
                const hpPercent = this.hp / this.maxHp;
                ctx.fillStyle = '#000';
                ctx.fillRect(this.x + 20, this.y + 5, 60, 8);
                ctx.fillStyle = hpPercent > 0.5 ? '#22C55E' : hpPercent > 0.25 ? '#EAB308' : '#EF4444';
                ctx.fillRect(this.x + 22, this.y + 7, 56 * hpPercent, 4);
            }
            
            update() {
                this.eating = false;
                
                // æ£€æµ‹æ˜¯å¦ç¢°åˆ°æ¤ç‰©
                for (let plant of plants) {
                    if (this.x < plant.x + CELL_WIDTH && this.x + CELL_WIDTH > plant.x &&
                        this.y === plant.y) {
                        this.eating = true;
                        this.eatTimer++;
                        if (this.eatTimer >= 30) {
                            plant.hp -= this.damage * 10;
                            this.eatTimer = 0;
                        }
                        break;
                    }
                }
                
                if (!this.eating) {
                    this.x -= this.speed;
                }
                
                // æ¸¸æˆç»“æŸæ£€æµ‹
                if (this.x < -50) {
                    gameRunning = false;
                    document.getElementById('gameOver').classList.remove('hidden');
                }
            }
        }
        
        // å­å¼¹ç±»
        class Projectile {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.speed = 5;
                this.damage = 20;
                this.radius = 8;
            }
            
            draw() {
                ctx.fillStyle = '#22C55E';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            
            update() {
                this.x += this.speed;
            }
        }
        
        // é˜³å…‰ç±»
        class Sun {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.targetY = y;
                this.radius = 25;
                this.value = 25;
                this.collected = false;
                this.lifeTime = 600; // 10ç§’åæ¶ˆå¤±
            }
            
            draw() {
                // ç»˜åˆ¶é˜³å…‰å…‰æ™•
                const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.radius + 10);
                gradient.addColorStop(0, 'rgba(251, 191, 36, 0.8)');
                gradient.addColorStop(1, 'rgba(251, 191, 36, 0)');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius + 10, 0, Math.PI * 2);
                ctx.fill();
                
                // ç»˜åˆ¶é˜³å…‰
                ctx.fillStyle = '#FBBF24';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // ç»˜åˆ¶emoji
                ctx.font = '25px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('â˜€ï¸', this.x, this.y);
            }
            
            update() {
                this.lifeTime--;
            }
        }
        
        // ç»˜åˆ¶è‰åªç½‘æ ¼
        function drawGrid() {
            for (let row = 0; row < GRID_ROWS; row++) {
                for (let col = 0; col < GRID_COLS; col++) {
                    const x = col * CELL_WIDTH;
                    const y = row * CELL_HEIGHT;
                    
                    // äº¤æ›¿é¢œè‰²çš„è‰åª
                    ctx.fillStyle = (row + col) % 2 === 0 ? '#22C55E' : '#16A34A';
                    ctx.fillRect(x, y, CELL_WIDTH, CELL_HEIGHT);
                    
                    // ç½‘æ ¼çº¿
                    ctx.strokeStyle = '#15803D';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, CELL_WIDTH, CELL_HEIGHT);
                }
            }
        }
        
        // é€‰æ‹©æ¤ç‰©
        function selectPlant(type) {
            selectedPlant = type;
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.plant-card').forEach(card => {
                card.classList.remove('ring-4', 'ring-blue-500');
            });
            event.currentTarget.classList.add('ring-4', 'ring-blue-500');
        }
        
        // ç‚¹å‡»ç”»å¸ƒç§æ¤æ¤ç‰©
        canvas.addEventListener('click', (e) => {
            if (!gameRunning) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const col = Math.floor(x / CELL_WIDTH);
            const row = Math.floor(y / CELL_HEIGHT);
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»é˜³å…‰
            for (let i = suns.length - 1; i >= 0; i--) {
                const sunObj = suns[i];
                const dist = Math.sqrt((x - sunObj.x) ** 2 + (y - sunObj.y) ** 2);
                if (dist < sunObj.radius + 10) {
                    suns.splice(i, 1);
                    sun += sunObj.value;
                    updateUI();
                    return;
                }
            }
            
            // ç§æ¤æ¤ç‰©
            if (selectedPlant && sun >= PLANT_TYPES[selectedPlant].cost) {
                const plantX = col * CELL_WIDTH;
                const plantY = row * CELL_HEIGHT;
                
                // æ£€æŸ¥è¯¥ä½ç½®æ˜¯å¦å·²æœ‰æ¤ç‰©
                const hasPlant = plants.some(p => p.x === plantX && p.y === plantY);
                
                if (!hasPlant) {
                    plants.push(new Plant(plantX, plantY, selectedPlant));
                    sun -= PLANT_TYPES[selectedPlant].cost;
                    updateUI();
                }
            }
        });
        
        // ç”Ÿæˆåƒµå°¸
        let zombieSpawnTimer = 0;
        function spawnZombie() {
            zombieSpawnTimer++;
            const spawnRate = Math.max(180, 600 - wave * 30); // éšæ³¢æ¬¡å¢åŠ ç”Ÿæˆé¢‘ç‡
            
            if (zombieSpawnTimer >= spawnRate) {
                const row = Math.floor(Math.random() * GRID_ROWS);
                zombies.push(new Zombie(row * CELL_HEIGHT));
                zombieSpawnTimer = 0;
            }
        }
        
        // è‡ªç„¶ç”Ÿæˆé˜³å…‰
        let naturalSunTimer = 0;
        function spawnNaturalSun() {
            naturalSunTimer++;
            if (naturalSunTimer >= 300) { // æ¯5ç§’
                const x = Math.random() * (canvas.width - 100) + 50;
                const y = Math.random() * (canvas.height - 100) + 50;
                suns.push(new Sun(x, y));
                naturalSunTimer = 0;
            }
        }
        
        // æ›´æ–°UI
        function updateUI() {
            document.getElementById('sunCount').textContent = sun;
            document.getElementById('score').textContent = score;
            document.getElementById('zombieCount').textContent = zombies.length;
            document.getElementById('wave').textContent = wave;
        }
        
        // ç¢°æ’æ£€æµ‹
        function checkCollisions() {
            // å­å¼¹å‡»ä¸­åƒµå°¸
            for (let i = projectiles.length - 1; i >= 0; i--) {
                const proj = projectiles[i];
                for (let j = zombies.length - 1; j >= 0; j--) {
                    const zombie = zombies[j];
                    const dist = Math.sqrt((proj.x - (zombie.x + CELL_WIDTH/2)) ** 2 + 
                                       (proj.y - (zombie.y + CELL_HEIGHT/2)) ** 2);
                    
                    if (dist < 40) {
                        zombie.hp -= proj.damage;
                        projectiles.splice(i, 1);
                        
                        if (zombie.hp <= 0) {
                            zombies.splice(j, 1);
                            score += 10;
                            updateUI();
                        }
                        break;
                    }
                }
            }
        }
        
        // æ¸…ç†æ­»äº¡æ¤ç‰©å’Œè¿‡æœŸé˜³å…‰
        function cleanup() {
            plants = plants.filter(p => p.hp > 0);
            suns = suns.filter(s => s.lifeTime > 0);
            projectiles = projectiles.filter(p => p.x < canvas.width + 50);
        }
        
        // æ³¢æ¬¡ç®¡ç†
        let waveTimer = 0;
        function manageWaves() {
            waveTimer++;
            if (waveTimer >= 1800) { // æ¯30ç§’å¢åŠ ä¸€æ³¢
                wave++;
                waveTimer = 0;
                updateUI();
            }
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            if (!gameRunning) return;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶ç½‘æ ¼
            drawGrid();
            
            // æ›´æ–°å’Œç»˜åˆ¶æ¤ç‰©
            plants.forEach(plant => {
                plant.update();
                plant.draw();
            });
            
            // æ›´æ–°å’Œç»˜åˆ¶åƒµå°¸
            zombies.forEach(zombie => {
                zombie.update();
                zombie.draw();
            });
            
            // æ›´æ–°å’Œç»˜åˆ¶å­å¼¹
            projectiles.forEach(proj => {
                proj.update();
                proj.draw();
            });
            
            // æ›´æ–°å’Œç»˜åˆ¶é˜³å…‰
            suns.forEach(sun => {
                sun.update();
                sun.draw();
            });
            
            // æ¸¸æˆé€»è¾‘
            spawnZombie();
            spawnNaturalSun();
            checkCollisions();
            cleanup();
            manageWaves();
            
            requestAnimationFrame(gameLoop);
        }
        
        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            sun = 100;
            score = 0;
            wave = 1;
            plants = [];
            zombies = [];
            projectiles = [];
            suns = [];
            gameRunning = true;
            zombieSpawnTimer = 0;
            naturalSunTimer = 0;
            waveTimer = 0;
            document.getElementById('gameOver').classList.add('hidden');
            updateUI();
            gameLoop();
        }
        
        // å¯åŠ¨æ¸¸æˆ
        updateUI();
        gameLoop();
    </script>
</body>
</html>