# 工具实践（二）编辑写入类：Write / Edit / MultiEdit 的原子性与回滚

如果说 LS/Glob/Grep/Read 是“看”，那么 Write / Edit / MultiEdit 就是“改”。这一类工具对稳定性要求极高：一次错误写入，整个项目就可能被污染。所以它们的核心设计目标不是“写得快”，而是“写得稳”。

本章关注三个工具：

- `tools/builtin/write_file.py`（Write）
- `tools/builtin/edit_file.py`（Edit）
- `tools/builtin/edit_file_multi.py`（MultiEdit）

## 1. 核心目标：可控的写入
这三种工具的共同目标非常明确：

- **拒绝越界写入**（路径必须在项目根目录内）
- **要求 Read 作为前置**（用于乐观锁与一致性校验）
- **原子写入**（临时文件 + replace，避免半写状态）
- **提供 diff 预览**（让模型知道改了什么）

也就是说，“写入”从一开始就不是任意覆盖，而是带有强约束的操作。

## 2. Write：全量覆盖，但带安全护栏
Write 是最“直接”的写入方式：把 content 全量写进文件。它适合新文件或大块重写，但同样风险最大，所以限制也最多。

关键设计点：

- **只允许相对路径**，绝对路径直接拒绝（避免越界）
- **沙箱检查**：路径必须在项目根目录内
- **乐观锁校验**：依赖 `expected_mtime_ms` / `expected_size_bytes`
- **原子写入**：先写临时文件再 `replace`
- **可选 dry_run**：只计算 diff，不落盘
- **自动创建目录**：写入不存在路径时，会创建父目录

Write 的 diff 预览会在 `MAX_DIFF_LINES` / `MAX_DIFF_BYTES` 内截断，并标记为 `partial`。这避免模型被大 diff 轰炸，同时保留“你确实改了什么”的证据。

**插图位置建议**：放在本节之后。  
**配图描述**：
“一张写入流程图：Path 校验 → 乐观锁校验 → diff 预览 → 原子写入（临时文件→replace），标注 dry_run 分支。”

## 3. Edit：单点替换，强约束
Edit 是单次、单位置的文本替换。它的理念是“精准修改”：

- **old_string 必须唯一**，出现 0 次或多次都直接报错
- **自动处理换行符**（CRLF/LF 探测与归一化）
- **必须先 Read**：否则拒绝执行
- **二进制检测**：避免对二进制文件误编辑
- **原子写入**：防止中途失败导致文件半写

Edit 的设计很“工程化”：它会强迫调用者给足上下文，确保替换的唯一性。这不是刁难模型，而是为了防止“误替换”这种极难追踪的事故。

**插图位置建议**：放在本节之后。  
**配图描述**：
“一张 ‘唯一性替换’ 示意图：old_string 在文件中出现 0 次 / 1 次 / 多次的三种分支，其中只有 1 次通过。”

## 4. MultiEdit：多点修改的原子提交
MultiEdit 的目标是：**一次修改多处，但保持原子性**。

它的实现方式非常讲究：

- 所有 `old_string` 都基于**原始文件内容**匹配
- 先定位每个替换区间，再检测是否重叠
- **倒序替换**，避免前面的修改影响后面的索引
- 最后一次性落盘（仍然是原子写入）

这种方式保证了多处修改不会互相干扰，也避免了多次 Edit 造成的中间态污染。

**插图位置建议**：放在本节之后。  
**配图描述**：
“一张多点编辑示意图：先定位多个区间，检测冲突，然后倒序应用替换，最后一次性写入。”

## 5. 为什么强调乐观锁
Write / Edit / MultiEdit 都依赖 `expected_mtime_ms` 和 `expected_size_bytes`，这些来自之前的 Read。这个机制的价值是：

- **避免“读旧写新”**
- 避免多个 Agent 或人同时修改时的覆盖
- 能把冲突显式地暴露出来

如果检测到文件已改变，它们会直接报错 `CONFLICT`，并提示重新 Read。这种“强制回读”在真实工程中非常重要。

## 6. 为什么强调 diff 预览
写入之前能看到 diff，有两个好处：

1) 模型能自我校验（是否改了不该改的地方）
2) 人类也能快速审查关键改动

因此即使写入成功，也会返回 diff 预览。只不过它会在一定长度后截断，避免污染上下文。

## 7. 小结
这三类编辑工具的核心不是“写入”，而是“控制写入”。

- **Write**：全量覆盖，但加了最强的安全护栏
- **Edit**：单点替换，追求唯一性
- **MultiEdit**：多点修改，但仍保持原子性

它们构成了 Agent 的“手”，但这只手必须稳定、可验证、可回滚。否则 Agent 就只是一个高风险的自动化脚本。
