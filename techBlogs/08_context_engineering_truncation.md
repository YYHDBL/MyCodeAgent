# 上下文工程（二）：截断策略、保留窗口与长程稳定性

上一章讲了“何时压缩”和“如何做 Summary”。这一章聚焦另一个现实问题：**工具输出会爆炸**。一次 `Grep` 或 `Read` 就可能把上下文塞满，而长程任务往往需要多次工具调用。如果没有统一的“截断策略”，Agent 会在长对话里逐步失控。

本章依据：

- `docs/工具输出截断设计文档.md`
- `core/context_engine/observation_truncator.py`
- `core/context_engine/history_manager.py`

## 1. 统一截断，而不是“工具各自为政”
MyCodeAgent 明确做了一个取舍：**所有工具输出统一截断，不再为每个工具写一套压缩逻辑**。

原因很简单：

- 工具越来越多，维护成本不可控
- 不同工具压缩方式不一致，模型容易误判
- 新工具上线会遗忘“写压缩逻辑”

统一截断策略把复杂度收敛到了一个地方：`ObservationTruncator`。

## 2. 截断规则是硬约束
统一策略的核心参数非常清晰：

- `MAX_LINES = 2000`
- `MAX_BYTES = 50KB`
- 默认截断方向：`head`

只要超出任意阈值，就会触发截断。被截断的输出会被落盘到 `tool-output/`，并且在返回中标注：

- `data.truncated = true`
- `data.truncation.full_output_path = ...`
- `text` 中提示“输出过大已截断”

这套规则在 `docs/工具输出截断设计文档.md` 中有完整规范，对应实现就在 `core/context_engine/observation_truncator.py`。

**插图位置建议**：放在本节之后。  
**图片内容描述**：
“一个截断规则示意图：显示 MAX_LINES / MAX_BYTES 双阈值，超过任意阈值触发截断，并落盘保存。”

## 3. 截断不是丢失，而是“可追溯”
截断并不等于丢失。它有两层保障：

1) **截断后的 preview**：模型仍能看到关键片段
2) **完整输出落盘**：`tool-output/` 中保留完整 JSON，可回溯

这意味着长程任务不需要牺牲信息完整性，只是把信息的“展示窗口”变小。

## 4. 截断发生在“写入历史之前”
一个很重要的实现细节：截断发生在 `HistoryManager.append_tool()` 中，而不是在工具内部。

也就是说：

- 工具仍返回完整结果
- 写入 history 前统一截断
- 模型的上下文永远不会被巨型工具输出撑爆

这是“工程层面的护栏”，而不是 prompt 里的约束。

## 5. 跳过截断的例外通道
有些场景确实需要完整输出（比如已经做了分页、或输出本来很短）。为此系统提供了跳过机制：

```json
{
  "context": {
    "truncation_skip": true
  }
}
```

只要工具返回时带上这个标记，截断器就会放行原始输出。

这是一种可控的“例外通道”，避免“一刀切”导致误伤。

## 6. 环境变量让截断可调
截断策略并不是硬编码死的，支持通过环境变量调整：

- `TOOL_OUTPUT_MAX_LINES`
- `TOOL_OUTPUT_MAX_BYTES`
- `TOOL_OUTPUT_TRUNCATE_DIRECTION`
- `TOOL_OUTPUT_DIR`
- `TOOL_OUTPUT_RETENTION_DAYS`

这让不同项目可以根据规模与成本进行权衡。

**插图位置建议**：放在本节之后。  
**图片内容描述**：
“一张配置面板风格的图，列出 5 个环境变量及默认值，突出‘可调节’。”

## 7. 长程任务为什么更需要截断
在短对话里，工具输出超大可能只是“浪费 tokens”。
在长对话里，它会引发更严重的问题：

- 上下文溢出导致压缩频繁触发
- 旧信息被更早挤出，Summary 负担加重
- 模型关注点被大量无关文本稀释

统一截断策略可以把“爆炸性输出”变成“可控预览”，在长程任务里尤为关键。

## 8. 截断不是压缩的替代品
截断解决的是“单次输出过大”的问题；
压缩解决的是“历史积累过长”的问题。

二者是互补的：

- 工具输出先被截断
- 历史增长后再被压缩

这也是 MyCodeAgent 把截断与压缩拆成两章讲的原因。

## 9. 小结
统一截断策略的价值在于：

- **把风险收敛到一个模块**
- **让工具输出不再威胁上下文窗口**
- **保留可追溯的完整结果**

对一个长期运行的 Agent 来说，这不是锦上添花，而是生存必需。

---

## 配图建议（可选）

1) **插图位置建议**：放在“2. 截断规则是硬约束”小节之后。  
**图片内容描述**：
“截断阈值示意图：MAX_LINES、MAX_BYTES 两条阈值线，超过任意一条触发截断与落盘。”

2) **插图位置建议**：放在“6. 环境变量让截断可调”小节之后。  
**图片内容描述**：
“一个简洁配置面板，列出 TOOL_OUTPUT_* 相关变量与默认值，视觉像配置界面。”

3) **插图位置建议**：放在“7. 长程任务为什么更需要截断”小节之后。  
**图片内容描述**：
“一个长对话时间轴，上面点状标注工具输出爆炸点，截断后变成短片段，整体更平稳。”
